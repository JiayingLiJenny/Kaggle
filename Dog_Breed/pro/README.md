


# 项目：实现一个狗品种识别算法
### 卷积神经网络（Convolutional Neural Network, CNN）

---

此项目可以作为移动端或 Web应用程序一部分的算法。在这个项目的最后，此程序将能够把用户提供的任何一个图像作为输入。如果可以从图像中检测到一只狗，它会输出对狗品种的预测。如果图像中是一个人脸，它会预测一个与其最相似的狗的种类。


### 项目内容
已将这个notebook分为不同的步骤，你可以使用下面的链接来浏览此notebook。

* [Step 0](#step0): 导入数据集
* [Step 1](#step1): 检测人脸
* [Step 2](#step2): 检测狗狗
* [Step 3](#step3): 从头创建一个CNN来分类狗品种
* [Step 4](#step4): 使用一个CNN来区分狗的品种(使用迁移学习)
* [Step 5](#step5): 建立一个CNN来分类狗的品种（使用迁移学习）
* [Step 6](#step6): 完成算法
* [Step 7](#step7): 测试算法


---
<a id='step0'></a>
## 步骤 0: 导入数据集

### 导入狗数据集
在下方的代码单元（cell）中，我们导入了一个狗图像的数据集。我们使用 scikit-learn 库中的 `load_files` 函数来获取一些变量：
- `train_files`, `valid_files`, `test_files` - 包含图像的文件路径的numpy数组
- `train_targets`, `valid_targets`, `test_targets` - 包含独热编码分类标签的numpy数组
- `dog_names` - 由字符串构成的与标签相对应的狗的种类


```python
from sklearn.datasets import load_files       
from keras.utils import np_utils
import numpy as np
from glob import glob

# 定义函数来加载train，test和validation数据集
def load_dataset(path):
    data = load_files(path)
    dog_files = np.array(data['filenames'])
    dog_targets = np_utils.to_categorical(np.array(data['target']), 133)
    return dog_files, dog_targets

# 加载train，test和validation数据集
train_files, train_targets = load_dataset('dogImages/train')
valid_files, valid_targets = load_dataset('dogImages/valid')
test_files, test_targets = load_dataset('dogImages/test')

# 加载狗品种列表
dog_names = [item[20:-1] for item in sorted(glob("dogImages/train/*/"))]

# 打印数据统计描述
print('There are %d total dog categories.' % len(dog_names))
print('There are %s total dog images.\n' % len(np.hstack([train_files, valid_files, test_files])))
print('There are %d training dog images.' % len(train_files))
print('There are %d validation dog images.' % len(valid_files))
print('There are %d test dog images.'% len(test_files))
```

    Using TensorFlow backend.


    There are 133 total dog categories.
    There are 8351 total dog images.
    
    There are 6680 training dog images.
    There are 835 validation dog images.
    There are 836 test dog images.


### 导入人脸数据集

在下方的代码单元中，我们导入人脸图像数据集，文件所在路径存储在名为 `human_files` 的 numpy 数组。


```python
import random
random.seed(8675309)

# 加载打乱后的人脸数据集的文件名
human_files = np.array(glob("lfw/*/*"))
random.shuffle(human_files)

# 打印数据集的数据量
print('There are %d total human images.' % len(human_files))
```

    There are 13233 total human images.


---
<a id='step1'></a>
## 步骤1：检测人脸
 
我们将使用 OpenCV 中的 [Haar feature-based cascade classifiers](http://docs.opencv.org/trunk/d7/d8b/tutorial_py_face_detection.html) 来检测图像中的人脸。OpenCV 提供了很多预训练的人脸检测模型，它们以XML文件保存在 [github](https://github.com/opencv/opencv/tree/master/data/haarcascades)。我们已经下载了其中一个检测模型，并且把它存储在 `haarcascades` 的目录中。

在如下代码单元中，我们将演示如何使用这个检测模型在样本图像中找到人脸。


```python
import cv2                
import matplotlib.pyplot as plt                        
%matplotlib inline                               

# 提取预训练的人脸检测模型
face_cascade = cv2.CascadeClassifier('haarcascades/haarcascade_frontalface_alt.xml')

# 加载彩色（通道顺序为BGR）图像
img = cv2.imread(human_files[3])

# 将BGR图像进行灰度处理
gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

# 在图像中找出脸
faces = face_cascade.detectMultiScale(gray)

# 打印图像中检测到的脸的个数
print('Number of faces detected:', len(faces))

# 获取每一个所检测到的脸的识别框
for (x,y,w,h) in faces:
    # 在人脸图像中绘制出识别框
    cv2.rectangle(img,(x,y),(x+w,y+h),(255,0,0),2)
    
# 将BGR图像转变为RGB图像以打印
cv_rgb = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
# R代表红，red; G代表绿，green; B代表蓝，blue。

# 展示含有识别框的图像
plt.imshow(cv_rgb)
plt.show()
```

    Number of faces detected: 1



![png](output_5_1.png)


在使用任何一个检测模型之前，将图像转换为灰度图是常用过程。`detectMultiScale` 函数使用储存在 `face_cascade` 中的的数据，对输入的灰度图像进行分类。

在上方的代码中，`faces` 以 numpy 数组的形式，保存了识别到的面部信息。它其中每一行表示一个被检测到的脸，该数据包括如下四个信息：前两个元素  `x`、`y` 代表识别框左上角的 x 和 y 坐标（参照上图，注意 y 坐标的方向和我们默认的方向不同）；后两个元素代表识别框在 x 和 y 轴两个方向延伸的长度 `w` 和 `d`。 

### 写一个人脸识别器

我们可以将这个程序封装为一个函数。该函数的输入为人脸图像的**路径**，当图像中包含人脸时，该函数返回 `True`，反之返回 `False`。该函数定义如下所示。


```python
# 如果img_path路径表示的图像检测到了脸，返回"True" 
def face_detector(img_path):
    img = cv2.imread(img_path)
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    faces = face_cascade.detectMultiScale(gray)
    return len(faces) > 0
```

### 评估人脸检测模型

 

在下方的代码块中，使用 `face_detector` 函数，计算：

- `human_files` 的前100张图像中，能够检测到**人脸**的图像占比多少？
- `dog_files` 的前100张图像中，能够检测到**人脸**的图像占比多少？

理想情况下，人图像中检测到人脸的概率应当为100%，而狗图像中检测到人脸的概率应该为0%。你会发现我们的算法并非完美，但结果仍然是可以接受的。我们从每个数据集中提取前100个图像的文件路径，并将它们存储在`human_files_short`和`dog_files_short`中。


```python
human_files_short = human_files[:100]
dog_files_short = train_files[:100]


## 基于human_files_short和dog_files_short
## 中的图像测试face_detector的表现
'''
human_human = 0
dog_human = 0
for i in range(100):
    if face_detector(human_files_short[i]):
        human_human += 1
    if face_detector(dog_files_short[i]):
        dog_human +=1

print("The percentage of human detected in human_files_short is: %.2f%%" % (100*human_human/100))
print('The percentage of human detected in dog_files_short is: %.2f%%' % (100*dog_human/100))

进行优化后的代码如下：
'''
human_human = np.mean([face_detector(f) for f in human_files_short])
dog_human = np.mean([face_detector(f) for f in dog_files_short])
print("The percentage of human detected in human_files_short is: {:.2%}".format(human_human))
print("The percentage of human detected in dog_files_short is: {:.2%}".format(dog_human))
```

    The percentage of human detected in human_files_short is: 100.00%
    The percentage of human detected in dog_files_short is: 11.00%


---
<a id='step2'></a>

## 步骤 2: 检测狗狗

在这个部分中，我们使用预训练的 [ResNet-50](http://ethereon.github.io/netscope/#/gist/db945b393d40bfa26006) 模型去检测图像中的狗。下方的第一行代码就是下载了 ResNet-50 模型的网络结构参数，以及基于 [ImageNet](http://www.image-net.org/) 数据集的预训练权重。

ImageNet 这目前一个非常流行的数据集，常被用来测试图像分类等计算机视觉任务相关的算法。它包含超过一千万个 URL，每一个都链接到 [1000 categories](https://gist.github.com/yrevar/942d3a0ac09ec9e5eb3a) 中所对应的一个物体的图像。任意输入一个图像，该 ResNet-50 模型会返回一个对图像中物体的预测结果。


```python
from keras.applications.resnet50 import ResNet50

# 定义ResNet50模型
ResNet50_model = ResNet50(weights='imagenet')
```

### 数据预处理

- 在使用 TensorFlow 作为后端的时候，在 Keras 中，CNN 的输入是一个4维数组（也被称作4维张量），它的各维度尺寸为 `(nb_samples, rows, columns, channels)`。其中 `nb_samples` 表示图像（或者样本）的总数，`rows`, `columns`, 和 `channels` 分别表示图像的行数、列数和通道数。


- 下方的 `path_to_tensor` 函数实现如下将彩色图像的字符串型的文件路径作为输入，返回一个4维张量，作为 Keras CNN 输入。因为我们的输入图像是彩色图像，因此它们具有三个通道（ `channels` 为 `3`）。
    1. 该函数首先读取一张图像，然后将其缩放为 224×224 的图像。
    2. 随后，该图像被调整为具有4个维度的张量。
    3. 对于任一输入图像，最后返回的张量的维度是：`(1, 224, 224, 3)`。


- `paths_to_tensor` 函数将图像路径的字符串组成的 numpy 数组作为输入，并返回一个4维张量，各维度尺寸为 `(nb_samples, 224, 224, 3)`。 在这里，`nb_samples`是提供的图像路径的数据中的样本数量或图像数量。你也可以将 `nb_samples` 理解为数据集中3维张量的个数（每个3维张量表示一个不同的图像。


```python
from keras.preprocessing import image                  
from tqdm import tqdm # 显示进度条

def path_to_tensor(img_path):
    # 用PIL加载RGB图像为PIL.Image.Image类型
    img = image.load_img(img_path, target_size=(224, 224))
    # 将PIL.Image.Image类型转化为格式为(224, 224, 3)的3维张量
    x = image.img_to_array(img)
    # 将3维张量转化为格式为(1, 224, 224, 3)的4维张量并返回
    return np.expand_dims(x, axis=0)

def paths_to_tensor(img_paths):
    list_of_tensors = [path_to_tensor(img_path) for img_path in tqdm(img_paths)]
    return np.vstack(list_of_tensors)
```

### 基于 ResNet-50 架构进行预测

对于通过上述步骤得到的四维张量，在把它们输入到 ResNet-50 网络、或 Keras 中其他类似的预训练模型之前，还需要进行一些额外的处理：
1. 首先，这些图像的通道顺序为 RGB，我们需要重排他们的通道顺序为 BGR。
2. 其次，预训练模型的输入都进行了额外的归一化过程。因此我们在这里也要对这些张量进行归一化，即对所有图像所有像素都减去像素均值 `[103.939, 116.779, 123.68]`（以 RGB 模式表示，根据所有的 ImageNet 图像算出）。

导入的 `preprocess_input` 函数实现了这些功能。可以在 [这里](https://github.com/fchollet/keras/blob/master/keras/applications/imagenet_utils.py) 查看 `preprocess_input`的代码。


在实现了图像处理的部分之后，我们就可以使用模型来进行预测。这一步通过 `predict` 方法来实现，它返回一个向量，向量的第 i 个元素表示该图像属于第 i 个 ImageNet 类别的概率。这通过如下的 `ResNet50_predict_labels` 函数实现。

通过对预测出的向量取用 argmax 函数（找到有最大概率值的下标序号），我们可以得到一个整数，即模型预测到的物体的类别。进而根据这个 [清单](https://gist.github.com/yrevar/942d3a0ac09ec9e5eb3a)，我们能够知道这具体是哪个品种的狗狗。



```python
from keras.applications.resnet50 import preprocess_input, decode_predictions
def ResNet50_predict_labels(img_path):
    # 返回img_path路径的图像的预测向量
    img = preprocess_input(path_to_tensor(img_path))
    return np.argmax(ResNet50_model.predict(img))
```

### 完成狗检测模型


在研究该 [清单](https://gist.github.com/yrevar/942d3a0ac09ec9e5eb3a) 的时候，可以发现，狗类别对应的序号为151-268。因此，在检查预训练模型判断图像是否包含狗的时候，我们只需要检查如上的 `ResNet50_predict_labels` 函数是否返回一个介于151和268之间（包含区间端点）的值。

我们通过这些想法来完成下方的 `dog_detector` 函数，如果从图像中检测到狗就返回 `True`，否则返回 `False`。


```python
def dog_detector(img_path):
    prediction = ResNet50_predict_labels(img_path)
    return ((prediction <= 268) & (prediction >= 151)) 
```

### 评估狗狗检测模型

---

在下方的代码块中，使用 `dog_detector` 函数，计算：

- `human_files_short`中图像检测到狗狗的百分比？
- `dog_files_short`中图像检测到狗狗的百分比？


```python
# 测试dog_detector函数在human_files_short和dog_files_short的表现
'''
human_dog = 0
dog_dog = 0
for i in range(100):
    if dog_detector(human_files_short[i]):
        human_dog += 1
    if dog_detector(dog_files_short[i]):
        dog_dog += 1

print("The percentage of dog detected in human_files_short is: %.2f%%" % (100*human_dog/100))
print('The percentage of dog detected in dog_files_short is: %.2f%%' % (100*dog_dog/100))
'''

human_dog = np.mean([dog_detector(f) for f in human_files_short])
dog_dog = np.mean([dog_detector(f) for f in dog_files_short])
print("The percentage of dog detected in human_files_short is: {:.2%}".format(human_dog))
print("The percentage of dog detected in dog_files_short is: {:.2%}".format(dog_dog))

# 可以把两个detector整合为一个函数
def get_detector_percentage(detector, data_files):
    return np.mean([detector(f) for f in data_files])
```

    The percentage of dog detected in human_files_short is: 0.00%
    The percentage of dog detected in dog_files_short is: 100.00%


---

<a id='step3'></a>

## 步骤 3: 从头开始创建一个CNN来分类狗品种


现在我们已经实现了一个函数，能够在图像中识别人类及狗狗。但我们需要更进一步的方法，来对狗的类别进行识别。在这一步中，实现一个卷积神经网络来对狗的品种进行分类。（这里不使用迁移学习，后面再使用迁移学习）

在添加卷积层的时候，越多的层和越多的参数意味着更长的训练时间，也就是说可能需要一个 GPU 来加速训练过程。

值得注意的是，对狗的图像进行分类是一项极具挑战性的任务。因为即便是一个正常人，也很难区分布列塔尼犬和威尔士史宾格犬。

同样，拉布拉多犬（labradors）有黄色、棕色和黑色这三种。那么此算法将不得不克服这种较高的类间差别，以达到能够将这些不同颜色的同类狗分到同一个品种中。

随机分类将得到一个非常低的结果：不考虑品种略有失衡的影响，随机猜测到正确品种的概率是1/133，相对应的准确率是低于1%的。



### 数据预处理


通过对每张图像的像素值除以255，我们对图像实现了归一化处理。


```python
from PIL import ImageFile                            
ImageFile.LOAD_TRUNCATED_IMAGES = True                 

# Keras中的数据预处理过程
train_tensors = paths_to_tensor(train_files).astype('float32')/255
valid_tensors = paths_to_tensor(valid_files).astype('float32')/255
test_tensors = paths_to_tensor(test_files).astype('float32')/255
```

    100%|██████████| 6680/6680 [02:15<00:00, 49.37it/s]
    100%|██████████| 835/835 [00:16<00:00, 49.34it/s]
    100%|██████████| 836/836 [00:15<00:00, 55.24it/s]


### 模型架构


创建一个卷积神经网络来对狗品种进行分类。在代码块的最后，执行 `model.summary()` 来输出模型的总结信息。



搭建卷积网络的具体步骤（用了哪些层）以及为什么这样搭建：

1. 搭建第一个卷积层，由于是第一层，添加input_shape为(224, 224, 3)，表示输入的是224*224像素且为3通道的彩色图片
2. 搭建第一个最大池化层，为了缩小维度减少参数数量，提高效率，同时pool_size与strides设为2，可使特征映射的宽和高都减小为原来的一半
3. 搭建第二个卷积层，filters设为第一卷积层的2倍，更多的过滤器能够获取图片中更多的规律。
4. 搭建第二个最大池化层，与第一个一样
5. 搭建第三个卷积层，filters设为第二卷积层的2倍，以获取更多图片规律。
6. 搭建第三个最大池化层，与第一个一样
7. 搭建全局平均池化层，将最后一个最大池化层的输出缩减为一个向量，作为最后一个密集层的输入
8. 搭建密集层，使用softmax为激活函数返回概率，使输出返回133类


```python
from keras.layers import Conv2D, MaxPooling2D, GlobalAveragePooling2D
from keras.layers import Dropout, Flatten, Dense
from keras.models import Sequential

model = Sequential()

# 定义网络架构
model.add(Conv2D(filters=16, kernel_size=2, padding='same', 
                 activation='relu', input_shape=(224, 224, 3))) 
model.add(MaxPooling2D(pool_size=2)) # strides默认为pool_size
model.add(Conv2D(filters=32, kernel_size=2, padding='same',
                 activation='relu'))
model.add(MaxPooling2D(pool_size=2))
model.add(Conv2D(filters=64, kernel_size=2, padding='same',
                 activation='relu'))
model.add(MaxPooling2D(pool_size=2))
model.add(GlobalAveragePooling2D()) 
model.add(Dense(133, activation='softmax'))
                 
model.summary()
```

    _________________________________________________________________
    Layer (type)                 Output Shape              Param #   
    =================================================================
    conv2d_1 (Conv2D)            (None, 224, 224, 16)      208       
    _________________________________________________________________
    max_pooling2d_3 (MaxPooling2 (None, 112, 112, 16)      0         
    _________________________________________________________________
    conv2d_2 (Conv2D)            (None, 112, 112, 32)      2080      
    _________________________________________________________________
    max_pooling2d_4 (MaxPooling2 (None, 56, 56, 32)        0         
    _________________________________________________________________
    conv2d_3 (Conv2D)            (None, 56, 56, 64)        8256      
    _________________________________________________________________
    max_pooling2d_5 (MaxPooling2 (None, 28, 28, 64)        0         
    _________________________________________________________________
    global_average_pooling2d_1 ( (None, 64)                0         
    _________________________________________________________________
    dense_1 (Dense)              (None, 133)               8645      
    =================================================================
    Total params: 19,189.0
    Trainable params: 19,189.0
    Non-trainable params: 0.0
    _________________________________________________________________



```python
## 编译模型
model.compile(optimizer='rmsprop', loss='categorical_crossentropy', metrics=['accuracy'])
```

---

## 训练模型


使用模型检查点（model checkpointing）来储存具有最低验证集 loss 的模型。

也可以对训练集进行 [数据增强](https://blog.keras.io/building-powerful-image-classification-models-using-very-little-data.html)，来优化模型的表现。




```python
from keras.callbacks import ModelCheckpoint  

# 设置训练模型的epochs的数量，为了避免过长的训练时间，因此选择了5个epochs

epochs = 5

checkpointer = ModelCheckpoint(filepath='saved_models/weights.best.from_scratch.hdf5', 
                               verbose=1, save_best_only=True)

history_cnn = model.fit(train_tensors, train_targets, 
          validation_data=(valid_tensors, valid_targets),
          epochs=epochs, batch_size=20, callbacks=[checkpointer], verbose=1)
```

    Train on 6680 samples, validate on 835 samples
    Epoch 1/5
    6660/6680 [============================>.] - ETA: 0s - loss: 4.7329 - acc: 0.0228  Epoch 00000: val_loss improved from inf to 4.76384, saving model to saved_models/weights.best.from_scratch.hdf5
    6680/6680 [==============================] - 284s - loss: 4.7325 - acc: 0.0228 - val_loss: 4.7638 - val_acc: 0.0216
    Epoch 2/5
    6660/6680 [============================>.] - ETA: 0s - loss: 4.7111 - acc: 0.0267      Epoch 00001: val_loss did not improve
    6680/6680 [==============================] - 261s - loss: 4.7114 - acc: 0.0271 - val_loss: 4.7730 - val_acc: 0.0251
    Epoch 3/5
    6660/6680 [============================>.] - ETA: 0s - loss: 4.6899 - acc: 0.0296  Epoch 00002: val_loss improved from 4.76384 to 4.72875, saving model to saved_models/weights.best.from_scratch.hdf5
    6680/6680 [==============================] - 267s - loss: 4.6898 - acc: 0.0295 - val_loss: 4.7287 - val_acc: 0.0204
    Epoch 4/5
    6660/6680 [============================>.] - ETA: 0s - loss: 4.6659 - acc: 0.0323  Epoch 00003: val_loss improved from 4.72875 to 4.72864, saving model to saved_models/weights.best.from_scratch.hdf5
    6680/6680 [==============================] - 267s - loss: 4.6660 - acc: 0.0322 - val_loss: 4.7286 - val_acc: 0.0204
    Epoch 5/5
    6660/6680 [============================>.] - ETA: 0s - loss: 4.6451 - acc: 0.0332      Epoch 00004: val_loss improved from 4.72864 to 4.70831, saving model to saved_models/weights.best.from_scratch.hdf5
    6680/6680 [==============================] - 268s - loss: 4.6449 - acc: 0.0332 - val_loss: 4.7083 - val_acc: 0.0263



```python
# list all data in history
print(history.history.keys())
# summarize history for accuracy
plt.plot(history_cnn.history['acc'])
plt.plot(history_cnn.history['val_acc'])
plt.title('model accuracy')
plt.ylabel('accuracy')
plt.xlabel('epoch')
plt.legend(['train', 'test'], loc='upper left')
plt.show()
# summarize history for loss
plt.plot(history_cnn.history['loss'])
plt.plot(history_cnn.history['val_loss'])
plt.title('model loss')
plt.ylabel('loss')
plt.xlabel('epoch')
plt.legend(['train', 'test'], loc='upper left')
plt.show()

## 加载具有最好验证loss的模型
model.load_weights('saved_models/weights.best.from_scratch.hdf5')
```

    dict_keys(['val_loss', 'val_acc', 'acc', 'loss'])



![png](output_30_1.png)



![png](output_30_2.png)


epochs选择为5的原因是：
1. 为了避免训练时间太长。
2. 随着epoch增加 ，模型的准确率并不是一直都在增加的。

---
### 测试模型

在狗图像的测试数据集应用此简单CNN模型。


```python
# 获取测试数据集中每一个图像所预测的狗品种的index
dog_breed_predictions = [np.argmax(model.predict(np.expand_dims(tensor, axis=0))) for tensor in test_tensors]

# 报告测试准确率
test_accuracy = 100*np.sum(np.array(dog_breed_predictions)==np.argmax(test_targets, axis=1))/len(dog_breed_predictions)
print('Test accuracy: %.4f%%' % test_accuracy)
```

    Test accuracy: 2.5120%


---
<a id='step4'></a>
## 步骤 4: 使用一个CNN来区分狗的品种


使用 迁移学习（Transfer Learning）的方法，能帮助我们在不损失准确率的情况下大大减少训练时间。


### 得到从图像中提取的特征向量（Bottleneck Features）


```python
bottleneck_features = np.load('bottleneck_features/DogVGG16Data.npz')
train_VGG16 = bottleneck_features['train']
valid_VGG16 = bottleneck_features['valid']
test_VGG16 = bottleneck_features['test']
```

### 模型架构

该模型使用预训练的 VGG-16 模型作为固定的图像特征提取器，其中 VGG-16 最后一层卷积层的输出被直接输入到我们的模型。我们只需要添加一个全局平均池化层以及一个全连接层，其中全连接层使用 softmax 激活函数，对每一个狗的种类都包含一个节点。


```python
VGG16_model = Sequential()
print(train_VGG16.shape[1:])
VGG16_model.add(GlobalAveragePooling2D(input_shape=train_VGG16.shape[1:]))
VGG16_model.add(Dense(133, activation='softmax'))

VGG16_model.summary()
```

    (7, 7, 512)
    _________________________________________________________________
    Layer (type)                 Output Shape              Param #   
    =================================================================
    global_average_pooling2d_3 ( (None, 512)               0         
    _________________________________________________________________
    dense_4 (Dense)              (None, 133)               68229     
    =================================================================
    Total params: 68,229.0
    Trainable params: 68,229.0
    Non-trainable params: 0.0
    _________________________________________________________________



```python
## 编译模型

VGG16_model.compile(loss='categorical_crossentropy', optimizer='rmsprop', metrics=['accuracy'])
```


```python
## 训练模型

checkpointer = ModelCheckpoint(filepath='saved_models/weights.best.VGG16.hdf5', 
                               verbose=1, save_best_only=True)

history_VGG16 = VGG16_model.fit(train_VGG16, train_targets, 
          validation_data=(valid_VGG16, valid_targets),
          epochs=20, batch_size=20, callbacks=[checkpointer], verbose=1)

```

    Train on 6680 samples, validate on 835 samples
    Epoch 1/20
    6520/6680 [============================>.] - ETA: 0s - loss: 6.6964 - acc: 0.5788Epoch 00000: val_loss improved from inf to 7.63481, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 6.7111 - acc: 0.5778 - val_loss: 7.6348 - val_acc: 0.4407
    Epoch 2/20
    6560/6680 [============================>.] - ETA: 0s - loss: 6.6811 - acc: 0.5799Epoch 00001: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 6.6825 - acc: 0.5796 - val_loss: 7.6755 - val_acc: 0.4503
    Epoch 3/20
    6620/6680 [============================>.] - ETA: 0s - loss: 6.5988 - acc: 0.5822Epoch 00002: val_loss improved from 7.63481 to 7.55914, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 6.6051 - acc: 0.5817 - val_loss: 7.5591 - val_acc: 0.4599
    Epoch 4/20
    6620/6680 [============================>.] - ETA: 0s - loss: 6.5802 - acc: 0.5864Epoch 00003: val_loss improved from 7.55914 to 7.49251, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 6.5747 - acc: 0.5867 - val_loss: 7.4925 - val_acc: 0.4647
    Epoch 5/20
    6640/6680 [============================>.] - ETA: 0s - loss: 6.5673 - acc: 0.5884Epoch 00004: val_loss improved from 7.49251 to 7.47090, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 6.5666 - acc: 0.5885 - val_loss: 7.4709 - val_acc: 0.4623
    Epoch 6/20
    6580/6680 [============================>.] - ETA: 0s - loss: 6.5610 - acc: 0.5901Epoch 00005: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 6.5576 - acc: 0.5903 - val_loss: 7.4894 - val_acc: 0.4599
    Epoch 7/20
    6520/6680 [============================>.] - ETA: 0s - loss: 6.5209 - acc: 0.5934Epoch 00006: val_loss improved from 7.47090 to 7.46087, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 6.5482 - acc: 0.5918 - val_loss: 7.4609 - val_acc: 0.4743
    Epoch 8/20
    6520/6680 [============================>.] - ETA: 0s - loss: 6.4986 - acc: 0.5925Epoch 00007: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 6.5247 - acc: 0.5907 - val_loss: 7.5190 - val_acc: 0.4683
    Epoch 9/20
    6500/6680 [============================>.] - ETA: 0s - loss: 6.4456 - acc: 0.5931Epoch 00008: val_loss improved from 7.46087 to 7.45352, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 6.4194 - acc: 0.5945 - val_loss: 7.4535 - val_acc: 0.4659
    Epoch 10/20
    6520/6680 [============================>.] - ETA: 0s - loss: 6.3568 - acc: 0.6003Epoch 00009: val_loss improved from 7.45352 to 7.39621, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 6.3515 - acc: 0.6007 - val_loss: 7.3962 - val_acc: 0.4671
    Epoch 11/20
    6520/6680 [============================>.] - ETA: 0s - loss: 6.3374 - acc: 0.6028Epoch 00010: val_loss improved from 7.39621 to 7.33198, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 6.3401 - acc: 0.6027 - val_loss: 7.3320 - val_acc: 0.4766
    Epoch 12/20
    6660/6680 [============================>.] - ETA: 0s - loss: 6.2546 - acc: 0.6024Epoch 00011: val_loss improved from 7.33198 to 7.30595, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 6.2552 - acc: 0.6024 - val_loss: 7.3059 - val_acc: 0.4719
    Epoch 13/20
    6580/6680 [============================>.] - ETA: 0s - loss: 6.1516 - acc: 0.6096Epoch 00012: val_loss improved from 7.30595 to 7.20527, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 6.1405 - acc: 0.6103 - val_loss: 7.2053 - val_acc: 0.4850
    Epoch 14/20
    6580/6680 [============================>.] - ETA: 0s - loss: 6.0732 - acc: 0.6173Epoch 00013: val_loss improved from 7.20527 to 7.17704, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 6.0935 - acc: 0.6160 - val_loss: 7.1770 - val_acc: 0.4754
    Epoch 15/20
    6560/6680 [============================>.] - ETA: 0s - loss: 6.0736 - acc: 0.6191Epoch 00014: val_loss improved from 7.17704 to 7.15025, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 3s - loss: 6.0707 - acc: 0.6190 - val_loss: 7.1502 - val_acc: 0.4790
    Epoch 16/20
    6520/6680 [============================>.] - ETA: 0s - loss: 6.0518 - acc: 0.6207Epoch 00015: val_loss improved from 7.15025 to 7.12888, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 6.0589 - acc: 0.6204 - val_loss: 7.1289 - val_acc: 0.4886
    Epoch 17/20
    6660/6680 [============================>.] - ETA: 0s - loss: 6.0478 - acc: 0.6224Epoch 00016: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 6.0538 - acc: 0.6220 - val_loss: 7.1877 - val_acc: 0.4910
    Epoch 18/20
    6600/6680 [============================>.] - ETA: 0s - loss: 6.0094 - acc: 0.6229Epoch 00017: val_loss improved from 7.12888 to 7.07652, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 6.0219 - acc: 0.6222 - val_loss: 7.0765 - val_acc: 0.4934
    Epoch 19/20
    6660/6680 [============================>.] - ETA: 0s - loss: 5.9611 - acc: 0.6269Epoch 00018: val_loss improved from 7.07652 to 7.04792, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 5.9626 - acc: 0.6268 - val_loss: 7.0479 - val_acc: 0.4946
    Epoch 20/20
    6560/6680 [============================>.] - ETA: 0s - loss: 5.9033 - acc: 0.6317Epoch 00019: val_loss improved from 7.04792 to 7.04008, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 5.9492 - acc: 0.6289 - val_loss: 7.0401 - val_acc: 0.4922



```python
## 加载具有最好验证loss的模型
VGG16_model.load_weights('saved_models/weights.best.VGG16.hdf5')

def plot_accuracy_loss(history_):
# list all data in history
    print(history_.history.keys())
# summarize history for accuracy
    plt.plot(history_.history['acc'])
    plt.plot(history_.history['val_acc'])
    plt.title('model accuracy')
    plt.ylabel('accuracy')
    plt.xlabel('epoch')
    plt.legend(['train', 'test'], loc='upper left')
    plt.show()
# summarize history for loss
    plt.plot(history_.history['loss'])
    plt.plot(history_.history['val_loss'])
    plt.title('model loss')
    plt.ylabel('loss')
    plt.xlabel('epoch')
    plt.legend(['train', 'test'], loc='upper left')
    plt.show()
    
    
plot_accuracy_loss(history_VGG16)
```

    dict_keys(['val_loss', 'val_acc', 'acc', 'loss'])



![png](output_40_1.png)



![png](output_40_2.png)


### 测试模型
现在，我们可以测试此CNN在狗图像测试数据集中识别品种的效果如何。我们在下方打印出测试准确率。


```python
# 获取测试数据集中每一个图像所预测的狗品种的index
VGG16_predictions = [np.argmax(VGG16_model.predict(np.expand_dims(feature, axis=0))) for feature in test_VGG16]

# 报告测试准确率
test_accuracy = 100*np.sum(np.array(VGG16_predictions)==np.argmax(test_targets, axis=1))/len(VGG16_predictions)
print('Test accuracy: %.4f%%' % test_accuracy)
```

    Test accuracy: 49.0431%


### 使用模型预测狗的品种


```python
from extract_bottleneck_features import *

def VGG16_predict_breed(img_path):
    # 提取bottleneck特征
    bottleneck_feature = extract_VGG16(path_to_tensor(img_path))
    # 获取预测向量
    predicted_vector = VGG16_model.predict(bottleneck_feature)
    # 返回此模型预测的狗的品种
    return dog_names[np.argmax(predicted_vector)]
```

---
<a id='step5'></a>
## 步骤 5: 建立一个CNN来分类狗的品种（使用迁移学习）


接下来将使用迁移学习来创建一个基于 ResNet-50 提取的特征向量而搭建的CNN。从而可以从图像中识别狗的品种。

- [ResNet-50](https://s3.cn-north-1.amazonaws.com.cn/static-documents/nd101/DLND+documents/DogResnet50Data.npz) bottleneck features




# 获取模型的特征向量

提取训练、测试与验证集相对应的bottleneck特征。



```python
# 获取bottleneck特征
bottleneck_features = np.load('bottleneck_features/DogResNet50Data.npz')
train_ResNet50 = bottleneck_features['train']
valid_ResNet50 = bottleneck_features['valid']
test_ResNet50 = bottleneck_features['test']
```

### 模型架构


使用 Keras 搭建最终的网络架构。

最终CNN架构及作用：
1. 创建一个sequential模型
2. 添加Flatten层，以预训练获得的bottleneck特征的训练集作为输入，将输入扁平化为向量输出
3. 添加Dropout层，在每个epoch随机指定某部分不接受训练，起到防止过拟合的作用
4. 添加密集层，使用softmax作为激活函数，把结果分为133类
----------------
使用预训练模型以及ResNet-50的原因：
1. 预训练模型是经过研究并在特定数据集上有很好表现的模型，通过事物间共性，使用预训练架构进行迁移学习能帮助提高准确率，节省大量时间。
2. 根据数据集的大小，以及与预训练架构中原始数据的相似度，针对特定的问题选择不同的预训练架构可以获得不同的结果。
3. ResNet50是一个在ImageNet中表现较好的模型，因此使用ResNet50的预训练架构在此问题上很有可能得到表现较好的迁移模型。
 




```python
# 框架
ResNet50_model_ = Sequential()
ResNet50_model_.add(Flatten(input_shape=train_ResNet50.shape[1:]))
ResNet50_model_.add(Dropout(0.3))
ResNet50_model_.add(Dense(133, activation='softmax'))
ResNet50_model_.summary()
```

    _________________________________________________________________
    Layer (type)                 Output Shape              Param #   
    =================================================================
    flatten_4 (Flatten)          (None, 2048)              0         
    _________________________________________________________________
    dropout_2 (Dropout)          (None, 2048)              0         
    _________________________________________________________________
    dense_5 (Dense)              (None, 133)               272517    
    =================================================================
    Total params: 272,517.0
    Trainable params: 272,517.0
    Non-trainable params: 0.0
    _________________________________________________________________



```python
# 编译模型
ResNet50_model_.compile(loss='categorical_crossentropy', optimizer='rmsprop', metrics=['accuracy'])
```

---

###  训练模型


使用模型检查点（model checkpointing）来储存具有最低验证集 loss 的模型。



```python
# 训练模型
checkpointer = ModelCheckpoint(filepath='saved_models/weights.best.ResNet50.hdf5',
                               verbose=1, save_best_only=True)
history_ResNet50 = ResNet50_model_.fit(train_ResNet50, train_targets,
                   validation_data=(valid_ResNet50, valid_targets),
                epochs=5, batch_size=20, callbacks=[checkpointer], verbose=1)
```

    Train on 6680 samples, validate on 835 samples
    Epoch 1/5
    6640/6680 [============================>.] - ETA: 0s - loss: 1.9224 - acc: 0.5348      Epoch 00000: val_loss improved from inf to 0.88014, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 6s - loss: 1.9162 - acc: 0.5361 - val_loss: 0.8801 - val_acc: 0.7257
    Epoch 2/5
    6540/6680 [============================>.] - ETA: 0s - loss: 0.5840 - acc: 0.8156Epoch 00001: val_loss improved from 0.88014 to 0.72705, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 3s - loss: 0.5849 - acc: 0.8153 - val_loss: 0.7271 - val_acc: 0.7749
    Epoch 3/5
    6600/6680 [============================>.] - ETA: 0s - loss: 0.4107 - acc: 0.8705Epoch 00002: val_loss improved from 0.72705 to 0.66519, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 3s - loss: 0.4098 - acc: 0.8708 - val_loss: 0.6652 - val_acc: 0.8036
    Epoch 4/5
    6660/6680 [============================>.] - ETA: 0s - loss: 0.3068 - acc: 0.9036Epoch 00003: val_loss improved from 0.66519 to 0.64387, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 3s - loss: 0.3064 - acc: 0.9037 - val_loss: 0.6439 - val_acc: 0.8072
    Epoch 5/5
    6620/6680 [============================>.] - ETA: 0s - loss: 0.2552 - acc: 0.9199Epoch 00004: val_loss did not improve
    6680/6680 [==============================] - 3s - loss: 0.2548 - acc: 0.9201 - val_loss: 0.6846 - val_acc: 0.8144



```python
# 加载具有最佳验证loss的模型权重
ResNet50_model_.load_weights('saved_models/weights.best.ResNet50.hdf5')



def plot_accuracy_loss(history_):
# list all data in history
    print(history_.history.keys())
# summarize history for accuracy
    plt.plot(history_.history['acc'])
    plt.plot(history_.history['val_acc'])
    plt.title('model accuracy')
    plt.ylabel('accuracy')
    plt.xlabel('epoch')
    plt.legend(['train', 'test'], loc='upper left')
    plt.show()
# summarize history for loss
    plt.plot(history_.history['loss'])
    plt.plot(history_.history['val_loss'])
    plt.title('model loss')
    plt.ylabel('loss')
    plt.xlabel('epoch')
    plt.legend(['train', 'test'], loc='upper left')
    plt.show()


plot_accuracy_loss(history_ResNet50)

```

    dict_keys(['val_loss', 'val_acc', 'acc', 'loss'])



![png](output_52_1.png)



![png](output_52_2.png)


---

### 测试模型

在狗图像的测试数据集上使用模型。


```python
# 在测试集上计算分类准确率
ResNet50_predictions = [np.argmax(ResNet50_model_.predict(np.expand_dims(feature, axis=0))) for feature in test_ResNet50]
test_accuracy = 100*np.sum(np.array(ResNet50_predictions)==np.argmax(test_targets, axis=1))/len(ResNet50_predictions)
print('Test accuracy: %.4f%%' % test_accuracy)
```

    Test accuracy: 80.9809%


---

### 使用模型测试狗的品种


输入为图像路径，功能为预测对应图像的类别，输出为模型预测出的狗类别（`Affenpinscher`, `Afghan_hound` 等）。

与步骤5中的模拟函数类似，函数包含如下三个步骤：

1. 根据选定的模型载入图像特征（bottleneck features）
2. 将图像特征输输入到你的模型中，并返回预测向量。注意，在该向量上使用 argmax 函数可以返回狗种类的序号。
3. 使用在步骤0中定义的 `dog_names` 数组来返回对应的狗种类名称。




```python
# 该函数将图像的路径作为输入
# 然后返回此模型所预测的狗的品种
from extract_bottleneck_features import extract_Resnet50
def Renet50_predict_breed(img_path):
    bottleneck_feature = extract_Resnet50(path_to_tensor(img_path))
    predicted_vector = ResNet50_model_.predict(bottleneck_feature)
    return dog_names[np.argmax(predicted_vector)]

```

---

<a id='step6'></a>
## 步骤 6: 完成算法



实现一个算法，它的输入为图像的路径，它能够区分图像是否包含一个人、狗或两者都不包含，然后：

- 如果从图像中检测到一只__狗__，返回被预测的品种。
- 如果从图像中检测到__人__，返回最相像的狗品种。
- 如果两者都不能在图像中检测到，输出错误提示。




```python

def detect_human_or_dogbreed(img_path):
    # 加载彩色（通道顺序为BGR）图像
    img = cv2.imread(img_path)
    # 将BGR图像转变为RGB图像
    cv_rgb = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
    # 展示图像
    plt.imshow(cv_rgb)
    plt.show()
    if face_detector(img_path):
        print('hello, human!')
        print('You look like a {}'.format(Renet50_predict_breed(img_path)))
    elif dog_detector(img_path):
        print('hello, this is a {}'.format(Renet50_predict_breed(img_path)))
    else:
        print('error input')
```

---
<a id='step7'></a>
## 步骤 7: 测试算法


下方使用了6张现实中的图片来测试算法。

** 结果 **

6张图片有5张预测对了，准确率达到了83%，跟预想的差不多。

** 改进的方法：**

(1) 数据增强
(2) 添加dropout层，避免过拟合
(3) 添加池化层，避免过拟合
(4) 更换激活函数


```python

detect_human_or_dogbreed('test_images/dog/dog_Labrador.jpg')
detect_human_or_dogbreed('test_images/dog/dog_Hasky.jpg')
detect_human_or_dogbreed('test_images/dog/dog_BichonFrise.jpg')
detect_human_or_dogbreed('test_images/human/human_gaoyuanyuan.jpg')
detect_human_or_dogbreed('test_images/human/human_huge.jpg')
detect_human_or_dogbreed('test_images/others/cat.jpg')
detect_human_or_dogbreed('test_images/others/panda.jpg')
```


![png](output_60_0.png)


    hello, this is a Labrador_retriever



![png](output_60_2.png)


    hello, human!
    You look like a Alaskan_malamute



![png](output_60_4.png)


    hello, this is a Bichon_frise



![png](output_60_6.png)


    hello, human!
    You look like a Maltese



![png](output_60_8.png)


    hello, human!
    You look like a Maltese



![png](output_60_10.png)


    error input



![png](output_60_12.png)


    error input

